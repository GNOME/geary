#
# Geary CI config.
#

variables:

  # Build
  BUILD_DIR: build
  CONFIG_CMD: meson --buildtype=debug build
  BUILD_CMD: ninja -v -C $BUILD_DIR
  TEST_CMD: xvfb-run meson test -v --no-stdsplit -C $BUILD_DIR
  INSTALL_CMD: ninja -v -C $BUILD_DIR install

  # Ubuntu & Debian packages
  UBUNTU_DEPS: valac libgirepository1.0-dev
               meson desktop-file-utils libcanberra-dev
               libgee-0.8-dev libglib2.0-dev libgmime-2.6-dev libgtk-3-dev
               libsecret-1-dev libxml2-dev libnotify-dev libsqlite3-dev
               libwebkit2gtk-4.0-dev libgcr-3-dev libenchant-dev
               libunwind-dev iso-codes libgoa-1.0-dev itstool gettext
               libmessaging-menu-dev libunity-dev libjson-glib-dev
  UBUNTU_TEST_DEPS: xauth xvfb

ubuntu:
  stage: build
  image: ubuntu:bionic
  before_script:
    - apt-get update
    - apt-get install -q -y --no-install-recommends $UBUNTU_DEPS $UBUNTU_TEST_DEPS
  script:
    - $CONFIG_CMD
    - $BUILD_CMD
    - $TEST_CMD
    - $INSTALL_CMD

deb-package:
  stage: test
  image: ubuntu:rolling
  before_script:
    - apt-get update
    - apt-get install -q -y --no-install-recommends packaging-dev $UBUNTU_DEPS
  script:
    - dpkg-buildpackage -b -us -uc
